#Import library
import requests
import json
import sqlite3
import os 
#functions

#Main

#Send a message to the cvetrends api endpoint
#Store that data in an object.

URL = "https://cvetrends.com/api/cves/24hrs"
headers = {"Accept-Encoding":"gzip, deflate","Accept-Language":"en-US,en;q=0.9"}
r = requests.get(url = URL, headers = headers)
cve_data = r

#Check to see if the api is up

print(cve_data)
if cve_data.status_code == 200:
    print('successful pull')
else:
    print('Unsucessful pull')

#Pull out only useful data
a = cve_data.json()

#Convert the large json string from the site into a list of dictionaries
vuln_items = (a['data'][0]["github_repos"])
for i in range(0,10):
    vuln_items += (a['data'][i]["github_repos"])
    #print(a['data'][i]["github_repos"])

#print(vuln_items)

#for testing: This is how to pull a single dictionary item from a list of dictionaries
#print(vuln_items[i]['url'])
#create our database items:

names =[]
links = []
for i in range(1,len(vuln_items)):
    names.append(vuln_items[i]['name'])
for i in range(1,len(vuln_items)):
    links.append(vuln_items[i]['url'])

# Create a sqlite3 database for storing the CVEs and github links.
conn = sqlite3.connect('vuln database.db') 
c = conn.cursor()
c.execute('''
          CREATE TABLE IF NOT EXISTS vulnerabilities
          ([vuln_name] TEXT, [github_repos] TEXT PRIMARY KEY)
          ''')

#need for loop. For i in dictionary
#https://stackoverflow.com/questions/50984179/insert-python-list-into-sqlite3-column

c.executemany("INSERT OR IGNORE INTO vulnerabilities VALUES (?,?)", zip(names, links))
conn.commit()

# Create a list of all of the github urls from the database

c.execute("SELECT github_repos from vulnerabilities")
rows = c.fetchall()
for row in rows:
    github_url = str(row).strip("'(,',)")
    filename = github_url.strip("https://github.com/")
    os.system(f"mkdir -p exploits/{filename}") 
    os.system(f"git clone {github_url} exploits/{filename}/ > /dev/null 2>&1")
